const express = require("express");
const fs = require("fs").promises;
const path = require('path');
const productList = require("./sampleData");

const filePath = path.join(__dirname, "access.log");

const app = express();

const writeFiles = async (logString) => {
    try {
        try {
            // Check if the file exists
            await fs.access(filePath);

            // File exists, read its content
            const fileContent = await fs.readFile(filePath, "utf8");

            // Check if the file is blank and write the task accordingly
            if (fileContent.trim() === "") {
                await fs.writeFile(filePath, logString);
            } else {
                await fs.writeFile(filePath, `${fileContent}\n${logString}`);
            }
        } catch (notFoundError) {
            // File does not exist, create it and write the task
            await fs.writeFile(filePath, logString);
        }
    } catch (error) {
        console.error(`Error adding task: ${error.message}`);
    }
};

app.use((req, res, next) => {
    const url = req.url,
        method = req.method,
        ip = req.ip;
    writeFiles(`Request URL: ${url}, Method: ${method} Time: ${new Date()}, IP: ${ip}`);
    next(); //allow to go next
});

app.get("/products", (req, res) => {
    console.log(req.url);
    res.json({
        success: true,
        results: productList
    });
});

app.get("/products/all", (req, res) => {
    console.log(req.url);
    res.json(productList);
});

app.use("*", (req, res) => {
    res.status(404).json({
        success: false,
        message: "Incorrect routes"
    });
});

app.listen(5000, () => {
    console.log("Server is running on port: 5000");
});
